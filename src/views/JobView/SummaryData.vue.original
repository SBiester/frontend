<template>
<div>
	<div v-if="hasAnyData" class="ref">
		<h3>Zusammenfassung - Job-Update</h3>
		<div class="warning-container">
			<p class="warning">Vergewissere dich noch einmal, dass alle von dir eingegebenen Daten korrekt sind.</p>
		</div>
		<!-- Mitarbeiter Basisdaten -->
		<div class="summary-section" v-if="hasBasicData">
			<h4>Mitarbeiter</h4>
			<div class="summary-content">
				<div class="summary-item" v-if="ju.vorname && ju.nachname">
					<strong>Name:</strong> {{ ju.vorname }} {{ ju.nachname }}
				</div>
				<div class="summary-item" v-if="ju.itUserName">
					<strong>IT Benutzername:</strong> {{ ju.itUserName }}
				</div>
				<div class="summary-item" v-if="ju.employerType !== null">
					<strong>Typ:</strong> {{ ju.employerType ? 'Intern' : 'Extern' }}
				</div>
				<div class="summary-item" v-if="ju.updateType">
					<strong>Update-Typ:</strong> {{ ju.updateType }}
				</div>
				<div class="summary-item" v-if="ju.bereich">
					<strong>Bereich:</strong> {{ ju.bereich }}
				</div>
				<div class="summary-item" v-if="ju.sachbereich">
					<strong>Sachbereich & Team:</strong> {{ ju.sachbereich }}
				</div>
				<div class="summary-item" v-if="ju.funktion">
					<strong>Funktion:</strong> {{ ju.funktion }}
				</div>
				<div class="summary-item" v-if="ju.vorgesetzt">
					<strong>Vorgesetzte:r:</strong> {{ ju.vorgesetzt }}
				</div>
				<div class="summary-item" v-if="ju.eintritt">
					<strong>Eintritt zum:</strong> {{ formatDate(ju.eintritt) }}
				</div>
				<div class="summary-item" v-if="ju.frist">
					<strong>Befristet bis:</strong> {{ formatDate(ju.frist) }}
				</div>
				<div class="summary-item" v-if="ju.verlaengerungbis">
					<strong>Verlängerung bis:</strong> {{ formatDate(ju.verlaengerungbis) }}
				</div>
				<div class="summary-item" v-if="ju.austritt_zum">
					<strong>Austritt zum:</strong> {{ formatDate(ju.austritt_zum) }}
				</div>
				<div class="summary-item" v-if="ju.wechsel_zum">
					<strong>Wechsel zum:</strong> {{ formatDate(ju.wechsel_zum) }}
				</div>
				<div class="summary-item" v-if="ju.aenderung_zum">
					<strong>Änderung zum:</strong> {{ formatDate(ju.aenderung_zum) }}
				</div>
			</div>
		</div>

		<!-- Referenzprofile -->
		<div class="summary-section" v-if="ju.refprofil && ju.refprofil.length > 0">
			<h4>Ausgewählte Referenzprofile</h4>
			<div class="summary-content">
				<div v-for="profil in ju.refprofil" :key="profil.id" class="profile-container">
					<div class="summary-item profile-item">
						{{ profil.name }}
					</div>
					
					<!-- Hardware vom Referenzprofil -->
					<div v-if="profileHardware[profil.name] && profileHardware[profil.name].length > 0" class="profile-items">
						<h5>Hardware aus diesem Profil:</h5>
						<div class="profile-item-list">
							<div v-for="item in profileHardware[profil.name]" :key="`hw-${item.id}`" class="summary-item hardware-item profile-sub-item">
								<span class="item-name">{{ item.name }}</span>
								<span class="item-category" v-if="item.category">({{ item.category }})</span>
							</div>
						</div>
					</div>

					<!-- Software vom Referenzprofil -->
					<div v-if="profileSoftware[profil.name] && profileSoftware[profil.name].length > 0" class="profile-items">
						<h5>Software aus diesem Profil:</h5>
						<div class="profile-item-list">
							<div v-for="item in profileSoftware[profil.name]" :key="`sw-${item.id}`" class="summary-item software-item profile-sub-item">
								<span class="item-name">{{ item.name }}</span>
								<span class="item-version" v-if="item.version">(v{{ item.version }})</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Zusätzliche Hardware -->
		<div class="summary-section" v-if="ju.additionalHardware && ju.additionalHardware.length > 0">
			<h4>Zusätzlich ausgewählte Hardware</h4>
			<div class="summary-content">
				<div v-for="item in ju.additionalHardware" :key="item.id" class="summary-item hardware-item">
					<span class="item-name">{{ item.name }}</span>
					<span class="item-category" v-if="item.kategorie">({{ item.kategorie }})</span>
				</div>
			</div>
		</div>

		<!-- Zusätzliche Software -->
		<div class="summary-section" v-if="ju.additionalSoftware && ju.additionalSoftware.length > 0">
			<h4>Zusätzlich ausgewählte Software</h4>
			<div class="summary-content">
				<div v-for="item in ju.additionalSoftware" :key="item.id" class="summary-item software-item">
					<span class="item-name">{{ item.name }}</span>
					<span class="item-manufacturer" v-if="item.hersteller">({{ item.hersteller }})</span>
				</div>
			</div>
		</div>

		<!-- Zusätzliche Optionen -->
		<div class="summary-section" v-if="ju.additionalOptions && hasSelectedOptions">
			<h4>Zusätzliche Services</h4>
			<div class="summary-content">
				<div v-if="ju.additionalOptions.telefonnummer" class="summary-item option-item">
					<i class=fa></i> Telefonnummer - Firmennummer mit persönlicher Durchwahl
					<div v-if="ju.additionalOptions.telefontyp" class="telefon-type-info">
						<strong>Telefontyp:</strong> {{ getTelefonTypeName(ju.additionalOptions.telefontyp) }}
					</div>
				</div>
				<div v-if="ju.additionalOptions.tuerschild" class="summary-item option-item">
					<i class=fa></i> Türschild - Namensschild für Büro oder Arbeitsplatz
				</div>
				<div v-if="ju.additionalOptions.visitenkarten" class="summary-item option-item">
					<i class=fa></i> Visitenkarten - Persönliche Visitenkarten mit Firmenlayout
				</div>
			</div>
		</div>

		<hr class="shadow-line" />
		<div class="navigation-buttons">
			<button @click="$emit('go-back')" class="back-button">
				Optionale Services
			</button>
			<button @click="submitJobUpdate" class="submit-button">
				Job-Update abschicken
			</button>
		</div>
		<hr class="shadow-line" />
	</div>
	<div v-else>
		<p>Keine Daten für die Zusammenfassung gefunden.</p>
	</div>
</div>
</template>

<script setup lang="ts">
import { computed, ref, onMounted } from 'vue';
import { useJuStore } from '@/stores/ju';

const juStore = useJuStore();
const ju = computed(() => juStore.ju);

const emit = defineEmits(['go-back', 'submit', 'back-to-navigation']);

// Profile-specific hardware and software
const profileHardware = ref({});
const profileSoftware = ref({});

const hasBasicData = computed(() => {
	return ju.value.vorname || ju.value.nachname || ju.value.bereich || ju.value.sachbereich;
});

const hasAnyData = computed(() => {
	return hasBasicData.value || 
		   (ju.value.refprofil && ju.value.refprofil.length > 0) ||
		   (ju.value.additionalHardware && ju.value.additionalHardware.length > 0) ||
		   (ju.value.additionalSoftware && ju.value.additionalSoftware.length > 0) ||
		   hasSelectedOptions.value;
});

const hasSelectedOptions = computed(() => {
	const options = ju.value.additionalOptions;
	if (!options || Array.isArray(options)) return false;
	return options.telefonnummer || options.tuerschild || options.visitenkarten;
});

const formatDate = (dateString) => {
	if (!dateString) return '';
	const date = new Date(dateString);
	return date.toLocaleDateString('de-DE');
};

// Fetch hardware and software for selected profiles
const fetchProfileData = async () => {
	if (!ju.value.refprofil || ju.value.refprofil.length === 0) return;

	for (const profil of ju.value.refprofil) {
		try {
			// Fetch hardware for this profile
			const hardwareResponse = await fetch(`/api/hardware/profile?profile=${encodeURIComponent(profil.name)}`);
			if (hardwareResponse.ok) {
				const hardwareData = await hardwareResponse.json();
				profileHardware.value[profil.name] = hardwareData.hardware || [];
			}

			// Fetch software for this profile
			const softwareResponse = await fetch(`/api/software/profile?profile=${encodeURIComponent(profil.name)}`);
			if (softwareResponse.ok) {
				const softwareData = await softwareResponse.json();
				profileSoftware.value[profil.name] = softwareData.software || [];
			}
		} catch (error) {
			console.error(`Fehler beim Laden der Profil-Daten für ${profil.name}:`, error);
		}
	}
};

// Get telefon type name by ID
const getTelefonTypeName = (typeId) => {
	if (typeId === 'standard') return 'Standard';
	if (typeId === 'komfort') return 'Komfort';
	return typeId; // fallback
};

const submitJobUpdate = async () => {
	console.log('Job-Update wird abgeschickt:', ju.value);
	
	try {
		const response = await fetch('/api/job-update', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'Accept': 'application/json',
			},
			body: JSON.stringify(ju.value)
		});

		const result = await response.json();

		if (response.ok && result.success) {
			console.log('Job-Update erfolgreich übermittelt:', result);
			alert(`Job-Update erfolgreich übermittelt!\nTicket-ID: ${result.ticket_id}`);
			emit('submit');
			// Nach erfolgreicher Übermittlung zurück zur Navigation
			emit('back-to-navigation');
		} else {
			console.error('Fehler beim Übermitteln des Job-Updates:', result);
			alert(`Fehler beim Übermitteln des Job-Updates: ${result.message}`);
		}
	} catch (error) {
		console.error('Netzwerkfehler beim Übermitteln des Job-Updates:', error);
		alert('Netzwerkfehler beim Übermitteln des Job-Updates. Bitte versuchen Sie es erneut.');
	}
};

// Load profile data when component mounts
onMounted(() => {
	fetchProfileData();
});
</script>

<style scoped>
@media (min-width: 1025px) {
	.ref {
		width: 66%;
	}
}

.summary-section {
	margin-bottom: 2rem;
	padding: 1.5rem;
	background: var(--color-background);
	border: 1px solid var(--color-border);
	border-radius: 0.5rem;
}

.summary-section h4 {
	margin: 0 0 1rem 0;
	color: var(--color-button-hover);
	font-size: 1.1rem;
	font-weight: 600;
	border-bottom: 2px solid var(--color-button-hover);
	padding-bottom: 0.5rem;
}

.summary-content {
	display: flex;
	flex-direction: column;
	gap: 0.8rem;
}

.summary-item {
	padding: 0.8rem;
	background: var(--color-background-mute);
	border-radius: 0.3rem;
	border-left: 3px solid var(--color-button);
}

.profile-item {
	background: rgba(var(--color-button-hover-rgb), 0.1);
	border-left-color: var(--color-button-hover);
	font-weight: 500;
}

.hardware-item, .software-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.item-name {
	font-weight: 500;
}

.item-category, .item-manufacturer {
	color: var(--color-text-muted);
	font-size: 0.9rem;
	font-style: italic;
}

.option-item {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	background: rgba(var(--color-button-hover-rgb), 0.05);
	border-left-color: var(--color-button-hover);
}

.navigation-buttons {
	display: flex;
	justify-content: space-between;
	align-items: center;
	gap: 1rem;
}

.back-button {
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.submit-button {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	background: var(--color-button-hover);
	color: white;
}

.submit-button:hover {
	background: var(--color-button);
	transform: translateY(-1px);
}

/* Profile container styles */
.profile-container {
	margin-bottom: 2rem;
}

.profile-items {
	margin: 1rem 0 0 1rem;
	padding: 1rem;
	background: var(--color-background-mute);
	border-radius: 0.3rem;
	border: 1px solid var(--color-border);
}

.profile-items h5 {
	margin: 0 0 0.8rem 0;
	color: var(--color-text);
	font-size: 0.95rem;
	font-weight: 600;
}

.profile-item-list {
	display: flex;
	flex-direction: column;
	gap: 0.5rem;
}

.profile-sub-item {
	margin: 0;
	padding: 0.6rem;
	background: var(--color-background);
	border-left: 2px solid var(--color-border);
	font-size: 0.9rem;
}

.profile-sub-item .item-name {
	font-weight: 400;
}

.item-version {
	color: var(--color-text-muted);
	font-size: 0.85rem;
	font-style: italic;
}

.warning-container {
	padding-bottom: 0.3rem;
}

.telefon-type-info {
	margin-top: 0.5rem;
	padding: 0.5rem;
	background: var(--color-background);
	border-radius: 0.3rem;
	border-left: 2px solid var(--color-button-hover);
	font-size: 0.9rem;
}
</style>